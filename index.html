<!DOCTYPE html>
<html>
	<head>
    <meta charset="utf-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ChatApp_Socket</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"></script>
    <script src="/socket.io/socket.io.js"></script>
		<title>Login Form Tutorial</title>
		<style>
		.login-form {
			width: 300px;
			margin: 0 auto;
			font-family: Tahoma, Geneva, sans-serif;
		}
		.login-form h1 {
			text-align: center;
			color: #4d4d4d;
			font-size: 24px;
			padding: 20px 0 20px 0;
		}
		.login-form input[type="password"],
		.login-form input[type="text"] {
			width: 100%;
			padding: 15px;
			border: 1px solid #dddddd;
			margin-bottom: 15px;
			box-sizing:border-box;
		}
		.login-form input[type="submit"] {
			width: 100%;
			padding: 15px;
			background-color: #535b63;
			border: 0;
			box-sizing: border-box;
			cursor: pointer;
			font-weight: bold;
			color: #ffffff;
		}
		</style>
	</head>
	<body>
    <div id="app">
      <div class="container">
          <div class="col-lg-6 offset-lg-3">

              <div v-if="ready">
                  <p v-for="user in info">
                      {{user.name}} {{user.type}}
                  </p>
              </div>

              <div v-if="!ready">
                  <h4>Enter your name</h4>
                  <form @submit.prevent="addUser">
                      <div class="form-group row">
                          <input type="text" class="form-control col-9" v-model="name"
                              placeholder="Enter name here">
                          <input type="text" class="form-control col-9" v-model="room"
                              placeholder="Enter room here">
                          <input type="submit" value="Join" class="btn btn-sm btn-info ml-1">

                      </div>
                  </form>
              </div>
              <h2 v-else>{{name}}</h2>
              <div class="card bg-info" v-if="ready">
                  <div class="card-header text-white">
                      <h4>My Chat App <span class="float-right">{{connections}} connections</span></h4>
                  </div>
                  <ul class="list-group list-group-flush text-right">
                      <small v-if="typing" class="text-white">{{typing}} is typing</small>
                      <li class="list-group-item" v-for="message in messages">
                          <span :class="{'float-left':message.type === 1}">
                              {{message.message}}
                              <small>:{{message.user}}</small>
                          </span>
                      </li>
                  </ul>

                  <div class="card-body">
                      <form @submit.prevent="send">
                          <div class="form-group">
                              <input type="text" class="form-control" v-model="newMessage"
                                  placeholder="Enter message here">
                          </div>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </div>
		<div class="login-form">
			<h1>Login Form</h1>
			<form action="/register" method="POST">
				<input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <input type="text" name="name" placeholder="Nom" required>
        <input type="text" name="surname" placeholder="Prenom" required>
        <input type="text" name="email" placeholder="Email" required>
				<input type="submit">
			</form>
		</div>
  </body>
  <script>
    var socket = io();
    let vue = new Vue({
        el: '#app',

        data: {
            newMessage: null,
            messages: [],
            typing: false,
            username: null,
            ready: false,
            info: [],
            connections: 0,
        },

        created() {
            window.onbeforeunload = () => {
                socket.emit('leave', this.name);
            }

            socket.on('Message', (message) => {
                this.messages.push({
                    message: data.message,
                    type: 1,
                    user: data.user,
                });
            });

            socket.on('typing', (data) => {
                this.typing = data;
            });


            socket.on('stopTyping', () => {
                this.typing = false;
            });

            socket.on('join', (data) => {
                this.info.push({
                    name: data,
                    room: room,
                    type: 'joined'
                });

                setTimeout(() => {
                    this.info = [];
                }, 5000);
            });

            socket.on('leave', (data) => {
                this.info.push({
                    name: data,
                    type: 'left'
                });

                setTimeout(() => {
                    this.info = [];
                }, 5000);
            });

            socket.on('connection', (data) => {
                this.connections = data;
            });
        },

        watch: {
            newMessage(value) {
                value ? socket.emit('typing', this.name) : socket.emit('stopTyping')
            }
        },

        methods: {
            send() {
                this.messages.push({
                    message: this.newMessage,
                    type: 0,
                    user: 'Me',
                });

                socket.emit('chat-message', {
                    message: this.newMessage,
                    user: this.username
                });
                this.newMessage = null;
            },

            addUser() {
                this.ready = true;
                let name = this.name;
                let room = this.room;
                socket.emit('join', { name, room } , () => {

                });
            }
        },

    });
</script>
</html>